# План разработки плагинов Renga_Grasshopper

## Цель проекта

**Основная задача**: Создание интеграции между Grasshopper и Renga для автоматического размещения колонн в Renga на основе точек, заданных в Grasshopper.

**Функциональность**:
- В Grasshopper пользователь задает точки (Point3D)
- Плагин Grasshopper экспортирует эти точки
- Плагин Renga импортирует точки и создает колонны в указанных позициях
- Используются свойства колонн по умолчанию из Renga

## Общая структура проекта

```
Renga_Grasshopper/
├── Renga/              # Плагин для Renga
│   ├── RengaPlugin.cs
│   ├── Renga.csproj
│   └── Renga.rndesc
├── Grasshopper/        # Плагин для Grasshopper
│   ├── Components/
│   │   └── CreateColumnsFromPoints.cs  # Компонент для экспорта точек
│   ├── Grasshopper.csproj
│   └── ...
└── Renga_Grasshopper.sln
```

---

## Этап 1: Настройка инфраструктуры проекта

### 1.1 Создание структуры проекта Renga
- [ ] Создать файл проекта `Renga.csproj` (библиотека классов)
- [ ] Настроить ссылки на Renga SDK:
  - `Renga.NET.PluginUtility.dll` или `Renga.NET8.PluginUtility.dll`
  - COM-компонент `RengaCOMAPI.tlb`
- [ ] Создать основной класс плагина `RengaPlugin.cs`, реализующий `Renga.IPlugin`
- [ ] Создать файл описания `Renga.rndesc` с метаданными плагина
- [ ] Настроить пути вывода в папку `bin` (для совместимости с Renga)

### 1.2 Создание структуры проекта Grasshopper
- [ ] Создать файл проекта `Grasshopper.csproj` (библиотека классов)
- [ ] Настроить ссылки на Grasshopper SDK:
  - `Grasshopper.dll`
  - `RhinoCommon.dll`
- [ ] Создать базовую структуру для компонентов Grasshopper
- [ ] Настроить пути вывода

### 1.3 Общее решение (Solution)
- [ ] Создать файл `Renga_Grasshopper.sln`
- [ ] Добавить оба проекта в решение
- [ ] Настроить зависимости между проектами (если необходимо)

### 1.4 Вспомогательные файлы
- [ ] Создать `.gitignore` для исключения временных файлов, bin/obj папок
- [ ] Создать `README.md` с описанием проекта и инструкциями
- [ ] Добавить файлы конфигурации (если необходимо)

---

## Этап 2: Разработка плагина для Renga

### 2.1 Базовая структура плагина
- [ ] Реализовать интерфейс `Renga.IPlugin`:
  - Метод `Initialize(string pluginFolder)` - инициализация плагина
  - Метод `Stop()` - остановка и очистка ресурсов
- [ ] Получить доступ к `Renga.Application` для взаимодействия с Renga
- [ ] Настроить базовую функциональность (UI элементы, события)

### 2.2 Функциональность плагина Renga
- [ ] **TCP Сервер**:
  - Запуск TCP сервера при инициализации плагина
  - Прослушивание на указанном порту (по умолчанию 50100)
  - Обработка входящих подключений от Grasshopper
  - Асинхронная обработка данных (чтобы не блокировать UI Renga)
  
- [ ] **UI элементы**:
  - Поле для ввода номера порта (по умолчанию 50100)
  - Кнопка "Start/Stop Server" для запуска/остановки сервера
  - Индикатор статуса сервера (запущен/остановлен)
  
- [ ] **Обработка данных от Grasshopper**:
  - Прием JSON данных через TCP соединение
  - Парсинг координат точек
  - Создание/обновление колонн в Renga:
    - Получить активный уровень (Level) или выбрать уровень
    - Для каждой точки создать/обновить колонну типа `ObjectTypes.Column`
    - Установить размещение (Placement3D) колонны в точке
    - Использовать свойства колонн по умолчанию
  - Отправка подтверждения обратно в Grasshopper (опционально)
  
- [ ] **Управление колоннами**:
  - При первом получении точек - создать колонны и сохранить GUID
  - При обновлении точек по GUID - обновить позиции существующих колонн
  - При добавлении новых точек (новый GUID) - создать новые колонны только для новых точек
  - **ВАЖНО**: Старые точки, которые уже имеют колонны, не должны создаваться заново
  - **ВАЖНО**: Если в Grasshopper добавили новые точки к существующим - создавать колонны только для новых точек
  - **ВАЖНО**: Не удалять существующие колонны, даже если количество точек изменилось
  - Отслеживание: если точка имеет `rengaColumnGuid` в запросе - это существующая колонна, обновить позицию
  - Отслеживание: если точка имеет только `grasshopperGuid` без `rengaColumnGuid` - проверить в кэше, есть ли уже колонна
  - Если колонна найдена в кэше по `grasshopperGuid` - обновить позицию, не создавать новую
  
- [ ] **Обработка ошибок**:
  - Порт занят - показать сообщение и предложить другой порт
  - Нет активного уровня - показать предупреждение
  - Некорректные данные - логирование ошибки
  - Разрыв соединения - логирование, сервер продолжает работать
  - **Управление колоннами по GUID**:
    - Хранить соответствие: Grasshopper Point GUID <-> Renga Column ID (в памяти и/или файле)
    - При получении точки с `rengaColumnGuid` - обновить существующую колонну (не создавать новую)
    - При получении точки с новым `grasshopperGuid` (не найден в кэше) - создать новую колонну
    - При получении точки с `grasshopperGuid`, который есть в кэше - обновить существующую колонну
    - При перемещении точки (изменение координат) - обновить позицию колонны через `SetPlacement()`
    - **ВАЖНО**: При добавлении новых точек к существующим - создавать колонны только для новых точек
    - **ВАЖНО**: Не создавать дубликаты колонн для точек, которые уже имеют колонны
    - Кэширование соответствия GUID между сессиями (сохранение в файл/память)

### 2.3 Тестирование плагина Renga
- [ ] Проверить загрузку плагина в Renga
- [ ] Протестировать базовую функциональность
- [ ] Убедиться в корректной работе с различными версиями Renga

---

## Этап 3: Разработка плагина для Grasshopper

### 3.1 Базовая структура плагина
- [ ] Создать класс плагина, наследующийся от `GH_AssemblyInfo`
- [ ] Зарегистрировать компоненты Grasshopper
- [ ] Настроить иконки и метаданные плагина

### 3.2 Компоненты Grasshopper

**Нода 1: "Renga Connect"** (ГЛАВНАЯ НОДА - управление соединением и передачей данных)
- [ ] **Входы**:
  - `Port` (Integer) - номер порта TCP сервера (по умолчанию 50100)
  - `Connect` (Boolean) - включить/выключить подключение (триггер для подключения)
  - `Commands` (Object, опционально) - команды от других нод (например, от "Renga Create Columns")
  - Host всегда "localhost" (127.0.0.1) - не настраивается пользователем
- [ ] **Выходы**:
  - `Connected` (Boolean) - статус подключения (true = подключен)
  - `Message` (String) - сообщение о статусе/ошибке
  - `Status` (String) - статус последней операции отправки данных
- [ ] **Функциональность**:
  - TCP клиент для подключения к серверу Renga
  - Управление состоянием подключения (включить/выключить)
  - **ГЛАВНАЯ ФУНКЦИЯ**: Получение команд от других нод и отправка данных на сервер Renga
  - При получении команды от ноды "Renga Create Columns" - отправка данных на сервер через TCP
  - Host всегда "localhost" (127.0.0.1) - не настраивается
  - Визуальная индикация статуса (цвет компонента: зеленый = подключен, красный = не подключен)
  - Кнопка "Update" для принудительного обновления подключения (кастомные атрибуты, как в примере ArchiCAD)
- [ ] **Особенности**:
  - Использовать кастомные атрибуты (`GH_ComponentAttributes`) для кнопки "Update"
  - Timeout для предотвращения зависания (10 секунд)
  - Обработка ошибок подключения с понятными сообщениями
  - Централизованная отправка всех данных на сервер Renga

**Нода 2: "Renga Create Columns"** (подготовка данных о колоннах для главной ноды)
- [ ] **Входы**:
  - `Points` (Point3D) - список точек для размещения колонн
  - `RengaConnect` (Object) - ссылка на главную ноду "Renga Connect"
  - Эта нода НЕ отправляет данные напрямую на сервер, а передает команды главной ноде
- [ ] **Выходы**:
  - `Success` (Boolean) - успешность операции для каждой колонны
  - `Message` (String) - сообщения о результате для каждой колонны
  - `ColumnGuids` (String) - GUID колонн в Renga для отслеживания
- [ ] **Функциональность**:
  - Принимает точки из Grasshopper
  - Генерирует GUID для каждой точки (используя Rhino GUID точки, если доступен)
  - Подготавливает команду для главной ноды "Renga Connect":
    - Команда: "create_columns" или "update_columns"
    - Данные: координаты точек (X, Y, Z), GUID точек, GUID колонн (если есть)
  - Передает команду главной ноде "Renga Connect" через вход `Commands`
  - Главная нода сама отправляет данные на сервер Renga через TCP
  - Отслеживание изменений координат точек:
    - При изменении координат точки с известным GUID - команда "update_columns"
    - При новой точке (новый GUID) - команда "create_columns"
  - Кнопка "Update" для принудительного обновления всех колонн (кастомные атрибуты)
  - **ВАЖНО**: Эта нода НЕ отправляет данные напрямую на сервер, только передает команды главной ноде
- [ ] **Отслеживание точек по GUID** (как в примере ArchiCAD с hotspot GUID):
  - Использовать Rhino GUID точек (если доступен) или генерировать собственный GUID
  - Хранить соответствие: Grasshopper Point GUID <-> Renga Column GUID
  - При перемещении точки в Grasshopper - обновлять позицию колонны в Renga
  - Кэширование GUID для сохранения соответствия между сессиями
  - Метод `HasCoordinatesChanged()` для проверки изменений координат (как в примере)
- [ ] **Формат данных для отправки**:
  ```json
  {
    "command": "update_points",
    "points": [
      {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0,
        "grasshopperGuid": "guid-точки-из-grasshopper",
        "rengaColumnGuid": "guid-колонны-в-renga" // если колонна уже создана
      }
    ],
    "timestamp": "2025-01-XX..."
  }
  ```
- [ ] Добавить валидацию входных данных (проверка точек, валидность порта)
- [ ] Добавить иконку компонента
- [ ] Обработка ошибок подключения с понятными сообщениями

### 3.3 Функциональность плагина Grasshopper

- [ ] **TCP Клиент (RengaGhClient)**:
  - Реализация TCP клиента для подключения к серверу Renga
  - Асинхронное подключение (не блокирует Grasshopper)
  - Timeout для предотвращения зависания (10 секунд)
  - Методы: `Connect()`, `Disconnect()`, `Send()`
  - Host всегда "localhost" (127.0.0.1) - не настраивается
  - Обработка ошибок подключения

- [ ] **Управление GUID точек**:
  - Получение Rhino GUID точек (если доступен)
  - Генерация собственного GUID для точек без Rhino GUID
  - Кэширование соответствия: Grasshopper Point GUID <-> Renga Column GUID
  - Отслеживание изменений координат точек по GUID
  - **ВАЖНО**: При обработке списка точек:
    - Для каждой точки проверять кэш по `grasshopperGuid`
    - Если GUID найден в кэше - использовать существующий `rengaColumnGuid` для обновления
    - Если GUID не найден - это новая точка, создавать новую колонну
    - Не создавать новые колонны для точек, которые уже имеют колонны в Renga

- [ ] **Формат команд для главной ноды**:
  - Нода "Renga Create Columns" подготавливает команду и передает главной ноде
  - Формат команды:
  ```json
  {
    "command": "create_columns", // или "update_columns"
    "points": [
      {
        "x": 0.0,
        "y": 0.0,
        "z": 0.0,
        "grasshopperGuid": "guid-точки",
        "rengaColumnGuid": "guid-колонны" // опционально, если колонна уже создана
      }
    ],
    "timestamp": "2025-01-XX..."
  }
  ```
  - Главная нода "Renga Connect" получает команду и отправляет данные на сервер Renga через TCP
  
- [ ] **Обработка координат**:
  - Преобразование единиц измерения (если Grasshopper в метрах, а Renga в мм)
  - Валидация координат перед отправкой
  - Обработка пустых списков точек
  
- [ ] **Отслеживание изменений**:
  - Использование `ExpireSolution` для отслеживания изменений точек
  - Метод `HasCoordinatesChanged()` для проверки изменений координат (как в примере ArchiCAD)
  - Передача команд главной ноде только при реальном изменении (оптимизация)
  - При изменении координат точки - передача команды "update_columns" главной ноде
  - При новой точке - передача команды "create_columns" главной ноде
  - Главная нода сама отправляет данные на сервер Renga

- [ ] **Кастомные атрибуты компонентов**:
  - Кнопка "Update" в компоненте "Renga Connect" (для принудительного обновления подключения)
  - Кнопка "Update" в компоненте "Renga Create Columns" (для принудительного обновления всех колонн)
  - Визуальная индикация статуса подключения (цвет компонента)

### 3.4 Тестирование плагина Grasshopper
- [ ] Проверить загрузку плагина в Grasshopper
- [ ] Протестировать каждый компонент
- [ ] Проверить интеграцию с Renga

---

## Этап 4: Интеграция между плагинами

### 4.1 Механизм обмена данными - Прямое TCP/IP соединение

**Выбранный вариант**: Прямое соединение через TCP/IP с автоматическим обновлением

- [ ] **Механизм**: TCP сервер в плагине Renga, TCP клиент в компоненте Grasshopper
- [ ] **Порт**: Настраиваемый порт (можно использовать любой свободный порт)
  - Рекомендуемый диапазон: 50000-65535 (динамические/приватные порты)
  - Примеры: 50100, 50101, 50102 и т.д.
  - По умолчанию можно использовать 50100 или любой другой удобный порт
  - Важно: порт должен быть свободен и доступен для прослушивания
- [ ] **Протокол обмена**: JSON через TCP сокет
- [ ] **Процесс работы**:
  1. При инициализации плагин Renga запускает TCP сервер на указанном порту
  2. Компонент Grasshopper подключается к серверу при активации
  3. При изменении точек в Grasshopper автоматически отправляются на сервер
  4. Плагин Renga получает данные в реальном времени и создает/обновляет колонны
  5. При отключении Grasshopper сервер продолжает работать (ожидает новое подключение)

- [ ] **Настройка порта в Renga**:
  - Добавить кнопку/меню "Settings" в UI плагина Renga
  - Поле для ввода номера порта (по умолчанию 50100 или настраиваемый)
  - Сохранение настроек порта (в файл конфигурации или реестр)
  - Валидация порта:
    - Диапазон: 1024-65535 (или 50000-65535 для приватных портов)
    - Проверка доступности порта перед запуском сервера
    - Предупреждение, если порт занят

- [ ] **Настройка порта в Grasshopper**:
  - Параметр компонента "Port" (по умолчанию 50100 или настраиваемый)
  - Параметр компонента "Host" (по умолчанию localhost/127.0.0.1)
  - Индикатор подключения (подключен/не подключен)
  - Валидация порта (диапазон 1024-65535)

- [ ] **Формат данных (JSON)**:
  ```json
  {
    "command": "update_points",
    "points": [
      {"x": 0.0, "y": 0.0, "z": 0.0},
      {"x": 1000.0, "y": 2000.0, "z": 0.0}
    ],
    "timestamp": "2025-01-XX..."
  }
  ```

**Технические детали TCP реализации:**

**В Renga (TCP Server):**
```csharp
// Использовать TcpListener для создания сервера
using System.Net;
using System.Net.Sockets;
using System.Threading.Tasks;

// Запуск сервера при инициализации плагина
private TcpListener tcpListener;
private bool isServerRunning = false;
private int serverPort = 50100; // Настраиваемый порт (по умолчанию 50100)

// Асинхронный метод для обработки подключений
private async Task StartTcpServer(int port)
{
    // Валидация порта (1024-65535)
    if (port < 1024 || port > 65535)
        throw new ArgumentException("Port must be in range 1024-65535");
    
    // Проверка доступности порта (опционально)
    // Можно использовать Socket для проверки
    
    tcpListener = new TcpListener(IPAddress.Any, port);
    tcpListener.Start();
    isServerRunning = true;
    serverPort = port;
    
    while (isServerRunning)
    {
        var client = await tcpListener.AcceptTcpClientAsync();
        _ = Task.Run(() => HandleClient(client));
    }
}

// Обработка данных от клиента
private async Task HandleClient(TcpClient client)
{
    // Чтение JSON данных
    // Парсинг и создание колонн
    // Закрытие соединения
}
```

**В Grasshopper (TCP Client):**
```csharp
// Использовать TcpClient для подключения
using System.Net.Sockets;
using System.Text;

// Подключение к серверу
private TcpClient tcpClient;
private NetworkStream stream;

// Отправка данных
private void SendPoints(List<Point3d> points)
{
    var json = SerializePointsToJson(points);
    var data = Encoding.UTF8.GetBytes(json);
    stream.Write(data, 0, data.Length);
}
```

- [ ] **Обработка ошибок**:
  - Порт занят - показать сообщение пользователю
  - Не удалось подключиться (Grasshopper) - показать статус в компоненте
  - Некорректные данные - логирование и игнорирование
  - Разрыв соединения - автоматическое переподключение (опционально)

### 4.2 Обработка данных и ошибок
- [ ] **Валидация данных**:
  - Валидация JSON перед парсингом
  - Проверка структуры данных (наличие поля "points")
  - Проверка корректности координат
  
- [ ] **Обработка в Renga**:
  - Проверка наличия активного уровня в Renga
  - Обработка дублирующихся точек (если необходимо)
  - Логирование процесса создания колонн
  - Сообщения пользователю об успехе/ошибках через UI
  
- [ ] **Обработка в Grasshopper**:
  - Обработка ошибок подключения (порт занят, сервер недоступен)
  - Визуальная индикация статуса (цвет компонента)
  - Понятные сообщения об ошибках в выходе "Message"
  
- [ ] **Управление соединением**:
  - Graceful shutdown при остановке плагина Renga
  - Автоматическое закрытие соединения при деактивации компонента Grasshopper
  - Обработка таймаутов при отправке данных

---

## Этап 5: Документация и финализация

### 5.1 Документация
- [ ] Обновить README.md с подробными инструкциями
- [ ] Добавить примеры использования
- [ ] Создать документацию по API (если необходимо)
- [ ] Добавить скриншоты и демонстрации

### 5.2 Тестирование
- [ ] Полное тестирование обоих плагинов
- [ ] Тестирование интеграции
- [ ] Проверка на различных версиях Renga и Grasshopper
- [ ] Исправление найденных ошибок

### 5.3 Подготовка к релизу
- [ ] Настроить версионирование
- [ ] Создать релизные сборки
- [ ] Подготовить установочные инструкции
- [ ] Закоммитить все изменения в репозиторий

---

## Технические детали

### Требования к проекту Renga:
- **Framework**: .NET Framework 4.8 или .NET 8.0
- **Platform**: x64
- **Зависимости**: 
  - Renga.NET.PluginUtility.dll (или Renga.NET8.PluginUtility.dll)
  - RengaCOMAPI.tlb (COM-компонент)

### Требования к проекту Grasshopper:
- **Framework**: .NET Framework 4.8 или выше
- **Platform**: x64
- **Зависимости**:
  - Grasshopper.dll
  - RhinoCommon.dll

### Структура файла .rndesc (Renga):
```xml
<RengaPlugin>
  <Name>Renga_Grasshopper Integration</Name>
  <Version>1.0</Version>
  <RequiredAPIVersion>2.41</RequiredAPIVersion>
  <Vendor>Your Name</Vendor>
  <Copyright>Copyright © 2025</Copyright>
  <PluginFilename>Renga.dll</PluginFilename>
  <PluginType>Net</PluginType>
</RengaPlugin>
```

### Технические детали создания колонн в Renga:

**API для создания колонн:**
```csharp
// 1. Получить модель
IModel model = app.Project.Model;

// 2. Получить активный уровень
ILevel level = ...; // из активного вида или выбор пользователя

// 3. Создать аргументы для объекта
var args = model.CreateNewEntityArgs();
args.TypeId = ObjectTypes.Column;

// 4. Создать объект
var op = app.Project.CreateOperationWithUndo(model.Id);
op.Start();
var column = model.CreateObject(args) as ILevelObject;
op.Apply();

// 5. Установить размещение колонны
var placement = new Placement3D();
placement.Origin = new Point3D { X = x, Y = y, Z = z };
placement.AxisX = new Vector3D { X = 1, Y = 0, Z = 0 };
placement.AxisY = new Vector3D { X = 0, Y = 1, Z = 0 };
placement.AxisZ = new Vector3D { X = 0, Y = 0, Z = 1 };
column.SetPlacement(placement);
```

**Формат JSON для точек:**
```json
{
  "points": [
    {"x": 0.0, "y": 0.0, "z": 0.0},
    {"x": 1000.0, "y": 2000.0, "z": 0.0},
    {"x": 5000.0, "y": 3000.0, "z": 0.0}
  ]
}
```

---

## Уточняющие вопросы (для дальнейшей разработки)

1. **Единицы измерения**: 
   - В каких единицах работают точки в Grasshopper? (метры, миллиметры?)
   - Renga работает в миллиметрах - нужна ли конвертация?

2. **Уровни (Levels)**:
   - На каком уровне создавать колонны? (активный уровень, первый уровень, выбор пользователя?)

3. **Свойства колонн**:
   - Какие свойства колонн использовать по умолчанию? (высота, материал, сечение)
   - Нужна ли возможность задавать эти параметры из Grasshopper в будущем?

4. **Обновление колонн**: ✅ **Определено**
   - Если колонны уже созданы и точки изменились - обновлять позиции существующих колонн
   - Если добавлены новые точки - создавать колонны только для новых точек
   - **ВАЖНО**: Не удалять существующие колонны, даже если количество точек изменилось
   - **ВАЖНО**: Не создавать дубликаты колонн для точек, которые уже имеют колонны

5. **Механизм обмена**: ✅ **Выбрано - Прямое TCP/IP соединение**
   - Порт: **Настраиваемый** (можно использовать любой свободный порт)
   - Рекомендуемый диапазон: **50000-65535** (например, 50100, 50101 и т.д.)
   - Порт по умолчанию: **50100** (или настраиваемый пользователем)
   - Настройка порта: через UI в плагине Renga
   - Автоматическое обновление из Grasshopper

## Следующие шаги

1. Начать с **Этапа 1** - создать базовую структуру проектов
2. Реализовать компонент Grasshopper для экспорта точек
3. Реализовать функциональность в Renga для создания колонн из точек
4. Протестировать интеграцию
5. Добавить обработку ошибок и улучшить UX

